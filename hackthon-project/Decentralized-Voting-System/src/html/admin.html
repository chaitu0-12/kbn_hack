<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin portal</title>

    <link rel="stylesheet" type="text/css" href="../css/admin.css" />
  </head>
  <body>
    <div id="head" class="text-center">
      <h1 align="center" style="color: azure">
        Decentralized Voting Using Ethereum Blockchain
      </h1>
      <br />
    </div>

    <div class="container">
      <legend>Add Candidate</legend>
      <table class="table text-center">
        <tr>
          <th>Name</th>
          <td>
            <input
              id="name"
              type="text"
              name="name"
              placeholder="Candidates name"
              autocomplete="off"
            />
          </td>
          <th>Party</th>
          <td>
            <input
              id="party"
              type="text"
              name="party"
              placeholder="Candidates party"
            />
          </td>
        </tr>
      </table>
      <input
        id="addCandidate"
        type="submit"
        name="submit"
        value="Add Candidate"
      />
      <p id="Aday"></p>
    </div>

    <div class="container">
      <legend>Define Voting Dates</legend>
      <table class="table text-center">
        <tr>
          <th>Start date</th>
          <td><input id="startDate" type="date" name="" /></td>
          <th>End date</th>
          <td><input id="endDate" type="date" name="" /></td>
        </tr>
      </table>
      <input id="addDate" type="submit" name="submit" value="Define Dates" />
      <p id="Aday"></p>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="../js/app.js" type="module"></script>
    <script type="module">
      // --- JWT Authorization Check ---
      const token = localStorage.getItem("jwtTokenAdmin");

      if (!token) {
        alert("Please login first");
        window.location.href = "login.html";
      }

      // Add Candidate
      async function addCandidate(name, party) {
        try {
          const response = await fetch("http://127.0.0.1:8000/add-candidate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ name, party }),
          });
          const data = await response.json();
          if (!response.ok)
            throw new Error(data.detail || "Failed to add candidate");
          alert("Candidate added successfully!");
        } catch (err) {
          console.error(err);
          alert(err.message);
        }
      }

      document.getElementById("addCandidate").addEventListener("click", () => {
        const name = document.getElementById("name").value;
        const party = document.getElementById("party").value;
        addCandidate(name, party);
      });

      // Define Voting Dates
      async function defineDates(startDate, endDate) {
        try {
          const response = await fetch("http://127.0.0.1:8000/set-dates", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ startDate, endDate }),
          });
          const data = await response.json();
          if (!response.ok)
            throw new Error(data.detail || "Failed to set dates");
          alert("Voting dates defined successfully!");
        } catch (err) {
          console.error(err);
          alert(err.message);
        }
      }

      document.getElementById("addDate").addEventListener("click", () => {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        defineDates(startDate, endDate);
      });
    </script>
  </body>
</html>
